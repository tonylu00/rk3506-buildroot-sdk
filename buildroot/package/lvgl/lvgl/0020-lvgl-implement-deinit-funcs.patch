From 2c48bb8314d7a27d5d6236e3d9331433b8f73011 Mon Sep 17 00:00:00 2001
From: Zou Dengming <marsow.zou@rock-chips.com>
Date: Mon, 9 Sep 2024 16:51:15 +0800
Subject: [PATCH] lvgl: implement deinit funcs

---
 src/core/lv_obj.c                     |  6 ++---
 src/core/lv_obj.h                     |  4 ---
 src/extra/libs/bmp/lv_bmp.c           |  3 ++-
 src/extra/libs/bmp/lv_bmp.h           |  2 +-
 src/extra/libs/freetype/lv_freetype.c | 12 +++++++--
 src/extra/libs/png/lv_png.c           |  4 ++-
 src/extra/libs/png/lv_png.h           |  2 +-
 src/extra/libs/sjpg/lv_sjpg.c         |  4 ++-
 src/extra/libs/sjpg/lv_sjpg.h         |  2 +-
 src/extra/lv_extra.c                  | 37 ++++++++++++++++++++++++---
 src/extra/lv_extra.h                  |  1 +
 src/hal/lv_hal_disp.c                 |  7 +++++
 src/hal/lv_hal_indev.c                | 19 ++++++++++++++
 src/hal/lv_hal_indev.h                |  1 +
 src/misc/lv_fs.c                      | 13 ++++++++++
 src/misc/lv_fs.h                      |  2 ++
 16 files changed, 101 insertions(+), 18 deletions(-)

diff --git a/src/core/lv_obj.c b/src/core/lv_obj.c
index 8890fcb..0883f86 100644
--- a/src/core/lv_obj.c
+++ b/src/core/lv_obj.c
@@ -183,10 +183,10 @@ void lv_init(void)
     LV_LOG_TRACE("finished");
 }
 
-#if LV_ENABLE_GC || !LV_MEM_CUSTOM
-
 void lv_deinit(void)
 {
+    lv_extra_deinit();
+#if LV_ENABLE_GC || !LV_MEM_CUSTOM
     _lv_gc_clear_roots();
 
     lv_disp_set_default(NULL);
@@ -198,8 +198,8 @@ void lv_deinit(void)
 #if LV_USE_LOG
     lv_log_register_print_cb(NULL);
 #endif
-}
 #endif
+}
 
 lv_obj_t * lv_obj_create(lv_obj_t * parent)
 {
diff --git a/src/core/lv_obj.h b/src/core/lv_obj.h
index c89e460..bb02329 100644
--- a/src/core/lv_obj.h
+++ b/src/core/lv_obj.h
@@ -201,16 +201,12 @@ typedef struct _lv_obj_t {
  */
 void lv_init(void);
 
-#if LV_ENABLE_GC || !LV_MEM_CUSTOM
-
 /**
  * Deinit the 'lv' library
  * Currently only implemented when not using custom allocators, or GC is enabled.
  */
 void lv_deinit(void);
 
-#endif
-
 /**
  * Returns whether the 'lv' library is currently initialized
  */
diff --git a/src/extra/libs/bmp/lv_bmp.c b/src/extra/libs/bmp/lv_bmp.c
index f89a0a8..709ae1e 100644
--- a/src/extra/libs/bmp/lv_bmp.c
+++ b/src/extra/libs/bmp/lv_bmp.c
@@ -51,13 +51,14 @@ static void decoder_close(lv_img_decoder_t * dec, lv_img_decoder_dsc_t * dsc);
 /**********************
  *   GLOBAL FUNCTIONS
  **********************/
-void lv_bmp_init(void)
+lv_img_decoder_t* lv_bmp_init(void)
 {
     lv_img_decoder_t * dec = lv_img_decoder_create();
     lv_img_decoder_set_info_cb(dec, decoder_info);
     lv_img_decoder_set_open_cb(dec, decoder_open);
     lv_img_decoder_set_read_line_cb(dec, decoder_read_line);
     lv_img_decoder_set_close_cb(dec, decoder_close);
+    return dec;
 }
 
 /**********************
diff --git a/src/extra/libs/bmp/lv_bmp.h b/src/extra/libs/bmp/lv_bmp.h
index db1e540..d09b010 100644
--- a/src/extra/libs/bmp/lv_bmp.h
+++ b/src/extra/libs/bmp/lv_bmp.h
@@ -27,7 +27,7 @@ extern "C" {
 /**********************
  * GLOBAL PROTOTYPES
  **********************/
-void lv_bmp_init(void);
+lv_img_decoder_t* lv_bmp_init(void);
 
 /**********************
  *      MACROS
diff --git a/src/extra/libs/freetype/lv_freetype.c b/src/extra/libs/freetype/lv_freetype.c
index 4bf6602..6acdb0d 100644
--- a/src/extra/libs/freetype/lv_freetype.c
+++ b/src/extra/libs/freetype/lv_freetype.c
@@ -153,9 +153,17 @@ Fail:
 void lv_freetype_destroy(void)
 {
 #if LV_FREETYPE_CACHE_SIZE >= 0
-    FTC_Manager_Done(cache_manager);
+    if (cache_manager != NULL) {
+        LV_LOG_INFO("%s cache_manager:%p\n", cache_manager);
+        FTC_Manager_Done(cache_manager);
+        cache_manager = NULL;
+    }
 #endif
-    FT_Done_FreeType(library);
+    if (library != NULL) {
+        LV_LOG_INFO("%s library:%p\n", library);
+        FT_Done_FreeType(library);
+        library = NULL;
+    }
 }
 
 bool lv_ft_font_init(lv_ft_info_t * info)
diff --git a/src/extra/libs/png/lv_png.c b/src/extra/libs/png/lv_png.c
index d067ef5..bc063c5 100644
--- a/src/extra/libs/png/lv_png.c
+++ b/src/extra/libs/png/lv_png.c
@@ -44,12 +44,14 @@ static void convert_color_depth(uint8_t * img, uint32_t px_cnt);
 /**
  * Register the PNG decoder functions in LVGL
  */
-void lv_png_init(void)
+lv_img_decoder_t* lv_png_init(void)
 {
     lv_img_decoder_t * dec = lv_img_decoder_create();
     lv_img_decoder_set_info_cb(dec, decoder_info);
     lv_img_decoder_set_open_cb(dec, decoder_open);
     lv_img_decoder_set_close_cb(dec, decoder_close);
+
+    return dec;
 }
 
 /**********************
diff --git a/src/extra/libs/png/lv_png.h b/src/extra/libs/png/lv_png.h
index 4380472..5302e22 100644
--- a/src/extra/libs/png/lv_png.h
+++ b/src/extra/libs/png/lv_png.h
@@ -31,7 +31,7 @@ extern "C" {
 /**
  * Register the PNG decoder functions in LVGL
  */
-void lv_png_init(void);
+lv_img_decoder_t* lv_png_init(void);
 
 /**********************
  *      MACROS
diff --git a/src/extra/libs/sjpg/lv_sjpg.c b/src/extra/libs/sjpg/lv_sjpg.c
index 5a12ea2..068c043 100644
--- a/src/extra/libs/sjpg/lv_sjpg.c
+++ b/src/extra/libs/sjpg/lv_sjpg.c
@@ -126,13 +126,15 @@ static void lv_sjpg_free(SJPEG * sjpeg);
 /**********************
  *   GLOBAL FUNCTIONS
  **********************/
-void lv_split_jpeg_init(void)
+lv_img_decoder_t* lv_split_jpeg_init(void)
 {
     lv_img_decoder_t * dec = lv_img_decoder_create();
     lv_img_decoder_set_info_cb(dec, decoder_info);
     lv_img_decoder_set_open_cb(dec, decoder_open);
     lv_img_decoder_set_close_cb(dec, decoder_close);
     lv_img_decoder_set_read_line_cb(dec, decoder_read_line);
+
+    return dec;
 }
 
 /**********************
diff --git a/src/extra/libs/sjpg/lv_sjpg.h b/src/extra/libs/sjpg/lv_sjpg.h
index d06e80d..4dc1a17 100644
--- a/src/extra/libs/sjpg/lv_sjpg.h
+++ b/src/extra/libs/sjpg/lv_sjpg.h
@@ -28,7 +28,7 @@ extern "C" {
  * GLOBAL PROTOTYPES
  **********************/
 
-void lv_split_jpeg_init(void);
+lv_img_decoder_t* lv_split_jpeg_init(void);
 
 /**********************
  *      MACROS
diff --git a/src/extra/lv_extra.c b/src/extra/lv_extra.c
index 0b50002..3e0013a 100644
--- a/src/extra/lv_extra.c
+++ b/src/extra/lv_extra.c
@@ -32,6 +32,10 @@
  *   GLOBAL FUNCTIONS
  **********************/
 
+lv_img_decoder_t *lv_bmp_extra = NULL;
+lv_img_decoder_t *lv_sjpeg_extra = NULL;
+lv_img_decoder_t *lv_png_extra = NULL;
+
 void lv_extra_init(void)
 {
 #if LV_USE_FLEX
@@ -67,15 +71,15 @@ void lv_extra_init(void)
 #endif
 
 #if LV_USE_PNG
-    lv_png_init();
+    lv_png_extra = lv_png_init();
 #endif
 
 #if LV_USE_SJPG
-    lv_split_jpeg_init();
+    lv_sjpeg_extra = lv_split_jpeg_init();
 #endif
 
 #if LV_USE_BMP
-    lv_bmp_init();
+    lv_bmp_extra = lv_bmp_init();
 #endif
 
 #if LV_USE_FREETYPE
@@ -88,6 +92,33 @@ void lv_extra_init(void)
 #endif
 }
 
+void lv_extra_deinit(void) {
+#if LV_USE_FREETYPE
+    lv_freetype_destroy();
+#endif
+
+#if LV_USE_BMP
+    if (lv_bmp_extra == NULL) {
+        lv_img_decoder_delete(lv_bmp_extra);
+        lv_bmp_extra = NULL;
+    }
+#endif
+
+#if LV_USE_SJPG
+    if (lv_bmp_extra == NULL) {
+        lv_img_decoder_delete(lv_sjpeg_extra);
+        lv_png_extra = NULL;
+    }
+#endif
+
+#if LV_USE_PNG
+    if (lv_png_extra == NULL) {
+        lv_img_decoder_delete(lv_png_extra);
+        lv_png_extra = NULL;
+    }
+#endif
+}
+
 /**********************
  *   STATIC FUNCTIONS
  **********************/
diff --git a/src/extra/lv_extra.h b/src/extra/lv_extra.h
index c0306a9..53fa921 100644
--- a/src/extra/lv_extra.h
+++ b/src/extra/lv_extra.h
@@ -36,6 +36,7 @@ extern "C" {
  * Initialize the extra components
  */
 void lv_extra_init(void);
+void lv_extra_deinit(void);
 
 /**********************
  *      MACROS
diff --git a/src/hal/lv_hal_disp.c b/src/hal/lv_hal_disp.c
index 0dd8f6b..da15e0f 100644
--- a/src/hal/lv_hal_disp.c
+++ b/src/hal/lv_hal_disp.c
@@ -310,6 +310,13 @@ void lv_disp_remove(lv_disp_t * disp)
 
     _lv_ll_remove(&LV_GC_ROOT(_lv_disp_ll), disp);
     if(disp->refr_timer) lv_timer_del(disp->refr_timer);
+
+    lv_disp_drv_t * driver = disp->driver;
+    if((driver != NULL) && (driver->draw_ctx != NULL)) {
+        driver->draw_ctx_deinit(driver, driver->draw_ctx);
+        lv_mem_free(driver->draw_ctx);
+    }
+
     lv_mem_free(disp);
 
     if(was_default) lv_disp_set_default(_lv_ll_get_head(&LV_GC_ROOT(_lv_disp_ll)));
diff --git a/src/hal/lv_hal_indev.c b/src/hal/lv_hal_indev.c
index c3661e4..6aea718 100644
--- a/src/hal/lv_hal_indev.c
+++ b/src/hal/lv_hal_indev.c
@@ -98,6 +98,25 @@ lv_indev_t * lv_indev_drv_register(lv_indev_drv_t * driver)
     return indev;
 }
 
+void lv_indev_drv_unregister(lv_indev_drv_t * driver) {
+    lv_indev_t * indev = _lv_ll_get_head(&LV_GC_ROOT(_lv_indev_ll));
+
+    LV_ASSERT_NULL(driver);
+    LV_ASSERT_NULL(indev);
+    while (indev) {
+        if (indev->driver == driver) {
+            if(indev->driver->read_timer) {
+                lv_timer_del(indev->driver->read_timer);
+                indev->driver->read_timer = NULL;
+            }
+            _lv_ll_remove(&LV_GC_ROOT(_lv_indev_ll), indev);
+            lv_mem_free(indev);
+            break;
+        }
+        indev = _lv_ll_get_next(&LV_GC_ROOT(_lv_indev_ll), indev);
+    }
+}
+
 /**
  * Update the driver in run time.
  * @param indev pointer to a input device. (return value of `lv_indev_drv_register`)
diff --git a/src/hal/lv_hal_indev.h b/src/hal/lv_hal_indev.h
index ca51a08..46981f2 100644
--- a/src/hal/lv_hal_indev.h
+++ b/src/hal/lv_hal_indev.h
@@ -200,6 +200,7 @@ void lv_indev_drv_init(struct _lv_indev_drv_t * driver);
  */
 lv_indev_t * lv_indev_drv_register(struct _lv_indev_drv_t * driver);
 
+void lv_indev_drv_unregister(lv_indev_drv_t * driver);
 /**
  * Update the driver in run time.
  * @param indev pointer to an input device. (return value of `lv_indev_drv_register`)
diff --git a/src/misc/lv_fs.c b/src/misc/lv_fs.c
index 52f3ce0..279d7b1 100644
--- a/src/misc/lv_fs.c
+++ b/src/misc/lv_fs.c
@@ -406,6 +406,19 @@ void lv_fs_drv_register(lv_fs_drv_t * drv_p)
     *new_drv = drv_p;
 }
 
+void lv_fs_drv_unregister(lv_fs_drv_t * drv_p)
+{
+    lv_fs_drv_t **new_drv = _lv_ll_get_head(&LV_GC_ROOT(_lv_fsdrv_ll));
+    while (new_drv) {
+        if (drv_p == *new_drv) {
+            _lv_ll_remove(&LV_GC_ROOT(_lv_fsdrv_ll), new_drv);
+            lv_mem_free(new_drv);
+            break;
+        }
+        new_drv = _lv_ll_get_next(&LV_GC_ROOT(_lv_fsdrv_ll), new_drv);
+    }
+}
+
 lv_fs_drv_t * lv_fs_get_drv(char letter)
 {
     lv_fs_drv_t ** drv;
diff --git a/src/misc/lv_fs.h b/src/misc/lv_fs.h
index 9f65e1b..d3f8812 100644
--- a/src/misc/lv_fs.h
+++ b/src/misc/lv_fs.h
@@ -131,6 +131,8 @@ void lv_fs_drv_init(lv_fs_drv_t * drv);
  */
 void lv_fs_drv_register(lv_fs_drv_t * drv);
 
+void lv_fs_drv_unregister(lv_fs_drv_t * drv);
+
 /**
  * Give a pointer to a driver from its letter
  * @param letter    the driver letter
-- 
2.25.1

